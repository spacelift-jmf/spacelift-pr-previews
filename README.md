# Spacelift PR Previews

This is an example of how to automatically create preview environments for PRs.

This is meant to be tailored to your specific needs. This example uses AWS as the cloud provider but it could be edited to use any combination of providers.

This repository holds the code for the manager stack. It is meants to be used in conjunction with repositories that hold your regular Infrastructure as Code source code to create previews for. An [example repository](https://github.com/spacelift-jmf/spacelift-pr-previews-example) that uses Terraform is provided but any platform supported by Spacelift, or any combination, would work.

## Overview

### Components

- **Manager stack**: [Spacelift stack](https://docs.spacelift.io/concepts/stack/) that manages the preview stacks using Terraform code generated by the repository automation.
- **Preview stacks**: Spacelift stacks that manage the resources for a specific PR preview.
- **Manager repository**: Git repository that holds the source code for the manager stack and preview stacks.
- **Monitored repositories**: Git repositories that hold the source code for the changes to preview.
- **Repository automation**: Scripts installed in the monitored repositoires that register and unregister the PR previews on certain PR events. These are different depending on the version control system used (e.g., GitHub Actions, Gitlab CI, Bitbucket Pipelines).

### Workflow

1. A user opens a PR in the version control system for one of the monitored repositories.
2. The repository automation automatically generates a Terraform file that leverages the Spacelfit Terraform provider to create a preview stack associated with the local source code, and pushes it to the manager repository.
3. The manager stack is automatically triggered and creates a monitored stack and triggers a run.
4. The preview stack's run creates the resources defined in the source code.
5. When the PR is updated, the same process repeats.
6. When the PR is merged or closed, the file that defines the preview stack is deleted, the resources associated with the preview stack are deleted and, finally, the preview stack is deleted.

## Installation

### Manager Stack

- Create a Terraform [administrative stack](https://docs.spacelift.io/concepts/stack/stack-settings#administrative) associated with this repository, with [auto-deploy](https://docs.spacelift.io/concepts/stack/stack-settings#autodeploy) enabled.

- Set the following [environment variables](https://docs.spacelift.io/concepts/configuration/environment#environment-variables) for the stack:

  - `TF_VAR_aws_cloud_integration_id`: ID of the AWS Cloud Integration
  - `TF_VAR_space_id`: ID of the space to create all resources in (optional, defaults to `legacy`)

### Repositories

#### Manager Repository

- Clone the [example manager repository](https://github.com/spacelift-jmf/spacelift-pr-previews), or copy its content to a new repository.

#### Monitored Repository

##### GitHub

- Clone the [example monitored repository](https://github.com/spacelift-jmf/spacelift-pr-previews-example), or copy its content to a new repository.

- Get a [GitHub personal access token](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens) that has the permissions to write to the manager repository and set the `PR_PREVIEW_GH_TOKEN` [action secret](https://docs.github.com/en/actions/security-guides/encrypted-secrets#creating-encrypted-secrets-for-a-repository).

- Set the following [action variables](https://docs.github.com/en/actions/learn-github-actions/variables#creating-configuration-variables-for-a-repository):

  - `PR_PREVIEW_GH_OWNER`: Name of the GitHub account or organization for the manager repository.

  - `PR_PREVIEW_GH_REPOSITORY`: Name of the GitHub manager repository.


## Tips

- To avoid naming conflicts, add a random suffix to resource names.
- Preview stacks can share resources to save money or when a resource must be unique. To do so, add a `main.ft` file in the `monitored-stacks/<STACK NAME>/preview-stacks/main.tf` file. You may need to edit the template in the repository automation to use the shared resources.
